<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modal Crop</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 2rem; }
        .test-container { max-width: 600px; margin: 0 auto; }
        input[type="file"] { margin: 1rem 0; padding: 0.5rem; }
        .btn { padding: 0.5rem 1rem; margin: 0.5rem; background: #4e9eb0; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #3d7a87; }
        
        /* Modal styles */
        #cropImageModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        #cropImageModal .modal-content {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            max-width: 900px;
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .modal-close:hover {
            color: #ec654f;
        }
        
        #cropImage {
            max-width: 100%;
            display: block;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Modal de Crop</h1>
        <p>Ce test v√©rifie que le modal de crop fonctionne correctement.</p>
        
        <div>
            <label for="testImage">S√©lectionnez une image :</label>
            <input type="file" id="testImage" accept="image/*">
        </div>
        
        <div>
            <button class="btn" onclick="testModal()">Test Modal Direct</button>
            <button class="btn" onclick="testCropper()">Test Cropper.js</button>
        </div>
        
        <div id="debug" style="margin-top: 2rem; padding: 1rem; background: #f5f5f5; border-radius: 4px;">
            <h3>Debug Info:</h3>
            <div id="debugContent">En attente...</div>
        </div>
    </div>

    <!-- Modal de recadrage d'image -->
    <div id="cropImageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="cropModalTitle">Recadrer l'image</h2>
                <button onclick="closeCropModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #4e9eb0;">
                    <p id="cropInstructions" style="margin: 0; color: #004a6d;">
                        <i class="fas fa-info-circle"></i> <strong>Instructions :</strong> Ajustez le cadrage en d√©pla√ßant et redimensionnant la zone de s√©lection.
                    </p>
                </div>
                <div style="max-height: 500px; overflow: hidden; background: #000; border-radius: 8px;">
                    <img id="cropImage" style="max-width: 100%; display: block;">
                </div>
                <div style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f5f5f5; border-radius: 6px;">
                    <div style="font-size: 0.9rem; color: #666;">
                        <span id="cropDimensions">Dimensions : -</span>
                    </div>
                    <div>
                        <button onclick="cropper && cropper.reset()" class="btn" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                            <i class="fas fa-undo"></i> R√©initialiser
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeCropModal()" class="btn">Annuler</button>
                <button type="button" onclick="validateCrop()" class="btn">
                    <i class="fas fa-check"></i> Valider et optimiser
                </button>
            </div>
        </div>
    </div>

    <script>
        let cropper = null;
        
        function updateDebug(message) {
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
        }
        
        function testModal() {
            updateDebug('üß™ Test modal direct...');
            document.getElementById('cropImageModal').style.display = 'flex';
            updateDebug('‚úÖ Modal affich√©');
        }
        
        function testCropper() {
            updateDebug('üß™ Test Cropper.js...');
            if (typeof Cropper === 'undefined') {
                updateDebug('‚ùå Cropper.js non charg√©');
                return;
            }
            updateDebug('‚úÖ Cropper.js disponible');
        }
        
        function openCropModal(file, preset = 'hero') {
            updateDebug('üöÄ openCropModal appel√©e avec: ' + file.name);
            
            const cropPresets = {
                'hero': {
                    ratio: 16 / 9,
                    title: 'Recadrer l\'image Hero',
                    instructions: 'Format 16:9 (paysage) - Id√©al pour les fonds de section principale'
                }
            };
            
            const config = cropPresets[preset] || cropPresets.hero;
            
            // V√©rifier que les √©l√©ments existent
            const modalTitle = document.getElementById('cropModalTitle');
            const modalInstructions = document.getElementById('cropInstructions');
            const modalImage = document.getElementById('cropImage');
            const modal = document.getElementById('cropImageModal');
            
            updateDebug('üîç √âl√©ments trouv√©s: modal=' + !!modal + ', title=' + !!modalTitle + ', image=' + !!modalImage);
            
            if (!modalTitle || !modalInstructions || !modalImage || !modal) {
                updateDebug('‚ùå √âl√©ments du modal manquants !');
                return;
            }
            
            // Mettre √† jour le titre et les instructions
            modalTitle.textContent = config.title;
            modalInstructions.innerHTML = 
                '<i class="fas fa-info-circle"></i> <strong>Instructions :</strong> ' + config.instructions;
            
            updateDebug('üìù Titre et instructions mis √† jour');
            
            // Lire le fichier
            const reader = new FileReader();
            reader.onload = function(e) {
                updateDebug('üìñ Fichier lu, taille: ' + e.target.result.length);
                
                modalImage.src = e.target.result;
                
                // Afficher le modal
                modal.style.display = 'flex';
                updateDebug('üëÅÔ∏è Modal affich√©');
                
                // V√©rifier que Cropper.js est disponible
                if (typeof Cropper === 'undefined') {
                    updateDebug('‚ùå Cropper.js non charg√© !');
                    return;
                }
                
                // Initialiser Cropper.js
                if (cropper) {
                    cropper.destroy();
                }
                
                updateDebug('üé® Initialisation de Cropper.js...');
                cropper = new Cropper(modalImage, {
                    aspectRatio: config.ratio,
                    viewMode: 2,
                    dragMode: 'move',
                    guides: true,
                    center: true,
                    highlight: true,
                    background: true,
                    autoCropArea: 0.9,
                    responsive: true,
                    restore: true,
                    checkCrossOrigin: true,
                    checkOrientation: true,
                    crop: function(event) {
                        const width = Math.round(event.detail.width);
                        const height = Math.round(event.detail.height);
                        document.getElementById('cropDimensions').textContent = 
                            'Dimensions : ' + width + ' √ó ' + height + ' px';
                    }
                });
                
                updateDebug('‚úÖ Cropper.js initialis√© avec succ√®s');
            };
            
            reader.onerror = function(e) {
                updateDebug('‚ùå Erreur lecture fichier: ' + e);
            };
            
            reader.readAsDataURL(file);
        }
        
        function closeCropModal() {
            updateDebug('üö™ Fermeture du modal');
            document.getElementById('cropImageModal').style.display = 'none';
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }
        
        function validateCrop() {
            updateDebug('‚úÖ Validation du crop');
            if (!cropper) return;
            
            cropper.getCroppedCanvas({
                maxWidth: 1920,
                maxHeight: 1080,
                fillColor: '#fff',
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            }).toBlob(function(blob) {
                updateDebug('üéØ Image cropp√©e g√©n√©r√©e: ' + blob.size + ' bytes');
                closeCropModal();
            }, 'image/jpeg', 0.95);
        }
        
        // Setup
        document.addEventListener('DOMContentLoaded', function() {
            updateDebug('üìÑ Page charg√©e');
            
            const testInput = document.getElementById('testImage');
            testInput.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    updateDebug('üì∏ Image s√©lectionn√©e: ' + this.files[0].name);
                    openCropModal(this.files[0], 'hero');
                }
            });
        });
    </script>
</body>
</html>
